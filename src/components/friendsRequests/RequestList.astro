---
// Importar la funciÃ³n para mostrar las solicitudes de amistad
import Logo from "../../components/Logo.astro";
import Layout from "../../layouts/Layout.astro";
import Navbar from "../../components/Navbar.astro";
---

<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap">
</head>

<Layout />

<!-- NAVBAR -->
<div class="navbar-container">
  <Navbar />
</div>

<!-- LOGO -->
<div class="logo-container">
  <Logo />
</div>

<!-- CONTENEDOR PRINCIPAL -->
<div class="container">
  <header class="header">
    <h2 class="title">SOLICITUDES DE AMISTAD</h2>
  </header>

  <!-- LISTA DE AMIGOS -->
  <client:only>
    <script>
      interface Solicitud {
        User1: {
          username: string;
          lastConnection: string;
        };
        User2: {
          username: string;
          lastConnection: string;
        };
      }
  
      let solicitudesData: Solicitud[] = [];
      let currentUsername: string = ''; 

        // FunciÃ³n para obtener el nombre de usuario
        const getUserData = async (userId: string) => {
          const url = `http://localhost:3000/main-screen/get-user/${userId}`;
          console.log(`ðŸ“¡ Realizando peticiÃ³n a: ${url}`);

          try {
            const response = await fetch(url);
            console.log(`ðŸ“¥ Respuesta recibida. CÃ³digo de estado: ${response.status}`);

            if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);

            const data = await response.json();
            console.log("âœ… Datos obtenidos del servidor:", data.username);

            currentUsername = data.username || "Guest"; // Guardamos el username
            console.log(`ðŸ“ Nombre de usuario actualizado en la interfaz: ${currentUsername}`);
            getSolicitudes(); // Llamamos a la funciÃ³n para obtener solicitudes despuÃ©s de obtener el username
          } catch (error) {
            console.error("âŒ Error obteniendo el nombre del usuario:", error);
          }
        };
  
      const getSolicitudes = async () => {
        try {
          const cookies = document.cookie || '';
          console.log("Cookies disponibles:", cookies);
  
          const userId = cookies
            .split('; ')
            .find(row => row && row.startsWith('id='))?.split('=')[1] || null;
  
          if (!userId) {
            console.log("Id no encontrado");
          } else {
            console.log("Id encontrado", userId);
            //Encontrar el username del usuario:
            await getUserData(userId);


            const response = await fetch(`http://localhost:3000/friends/get_solicitudes/${userId}`);
            const data = await response.json();
            solicitudesData = data;
            console.log("Solicitudes de amistad:", solicitudesData);
  
            const solicitudesList = document.getElementById("solicitudes-list");
            if (solicitudesList) {
              const filteredSolicitudes = solicitudesData.filter(solicitud => solicitud.User1.username !== currentUsername);
              solicitudesList.innerHTML = filteredSolicitudes.length > 0
                ? filteredSolicitudes.map((solicitud) => {
                  const lastConnectionDate = new Date(solicitud.User1.lastConnection);
                  const hoursAgo = Math.floor((new Date().getTime() - lastConnectionDate.getTime()) / (1000 * 60 * 60)); // Horas desde la Ãºltima conexiÃ³n
                  return `
                    <div class="friend-item">
                      <div class="friend-info">
                        <span class="friend-name"><strong>${solicitud.User1.username}</strong></span>
                        <span class="friend-status">En lÃ­nea hace ${hoursAgo} horas</span>
                      </div>
                      <div class="friend-actions">
                        <button class="add-btn">
                          <img src="/images/amigos/aceptar_amigos.png" alt="Aceptar" />
                        </button>
                        <button class="remove-btn">
                          <img src="/images/amigos/eliminar_amigos.png" alt="Eliminar" />
                        </button>
                      </div>
                    </div>
                  `;}).join('')
                : '<div class="no-solicitudes"><p>No tienes solicitudes pendientes.</p></div>';

                if (solicitudesData.length === 0) {
                  const noSolicitudes = solicitudesList.querySelector('.no-solicitudes') as HTMLElement;
                  if (noSolicitudes) {
                    noSolicitudes.style.textAlign = 'center';
                    noSolicitudes.style.fontSize = '18px';
                    noSolicitudes.style.color = '#ccc';
                    noSolicitudes.style.fontWeight = 'bold';
                    noSolicitudes.style.padding = '20px';
                    noSolicitudes.style.border = '2px dashed #774a9b';
                    noSolicitudes.style.borderRadius = '10px';
                    noSolicitudes.style.background = 'rgba(255, 255, 255, 0.05)';
                    noSolicitudes.style.display = 'flex';
                    noSolicitudes.style.flexDirection = 'column';
                    noSolicitudes.style.alignItems = 'center';
                    noSolicitudes.style.justifyContent = 'center';
                    noSolicitudes.style.gap = '10px';
                    noSolicitudes.style.maxWidth = '400px';
                    noSolicitudes.style.margin = '20px auto';
                  }
                } else {
                  const friendItems = solicitudesList.querySelectorAll('.friend-item');
                  /* Estilos para las solicitudes */
    
                  friendItems.forEach(item => {
                    const friendItem = item as HTMLElement;
  
                    friendItem.style.display = 'flex';
                    friendItem.style.justifyContent = 'space-between';
                    friendItem.style.alignItems = 'center';
                    friendItem.style.background = '#888';
                    friendItem.style.padding = '12px';
                    friendItem.style.borderRadius = '5px';
                    friendItem.style.marginBottom = '8px';
                    friendItem.style.width = "600px";

                    const friendInfo = item.querySelector('.friend-info') as HTMLElement;
                    const friendName = item.querySelector('.friend-name') as HTMLElement;
                    const friendStatus = item.querySelector('.friend-status') as HTMLElement;
                    const addBtn = item.querySelector('.add-btn') as HTMLElement;
                    const removeBtn = item.querySelector('.remove-btn') as HTMLElement;
                    const denyBtn = item.querySelector('.deny-btn') as HTMLElement;
      
                    // Estilos para la informaciÃ³n del amigo
                    if (friendInfo) {
                      friendInfo.style.display = 'flex';
                      friendInfo.style.flexDirection = 'row';
                      friendInfo.style.alignItems = 'center';
                      friendInfo.style.gap = '15px';
                    }
                    
                    if (friendName) {
                      friendName.style.fontFamily = "'Luckiest Guy', cursive";
                      friendName.style.fontSize = '28px';
                      friendName.style.letterSpacing = '1px';
                    }
                    
                    if (friendStatus) {
                      friendStatus.style.color = '#ddd';
                      friendStatus.style.fontSize = '14px';
                      friendStatus.style.whiteSpace = 'nowrap';
                    }

                    if (addBtn) {
                      addBtn.style.backgroundColor = 'none';
                      addBtn.style.border = '2px solid green';
                      addBtn.style.borderRadius = '50%';
                      addBtn.style.padding = '8px';
                      addBtn.style.display = 'flex';
                      addBtn.style.justifyContent = 'center';
                      addBtn.style.alignItems = 'center';
                      addBtn.style.cursor = 'pointer';
                      addBtn.style.transition = 'background-color 0.3s ease, transform 0.2s ease';  // TransiciÃ³n suave para el fondo y la transformaciÃ³n
                    }

                    if (addBtn?.querySelector('img')) {
                      const addImg = addBtn.querySelector('img');
                      if (addImg) {
                        addImg.style.width = '20px';
                      }
                    }

                    if (removeBtn) {
                      removeBtn.style.backgroundColor = 'none';
                      removeBtn.style.border = '2px solid red';
                      removeBtn.style.borderRadius = '50%';
                      removeBtn.style.padding = '8px';
                      removeBtn.style.display = 'flex';
                      removeBtn.style.justifyContent = 'center';
                      removeBtn.style.alignItems = 'center';
                      removeBtn.style.cursor = 'pointer';
                      removeBtn.style.transition = 'background-color 0.3s ease, transform 0.2s ease';  // TransiciÃ³n suave para el fondo y la transformaciÃ³n
                    }

                    if (removeBtn?.querySelector('img')) {
                      const removeImg = removeBtn.querySelector('img');
                      if (removeImg) {
                        removeImg.style.width = '20px';
                      }
                    }

                    // Efecto hover para el botÃ³n de aceptar
                    if (addBtn) {
                      addBtn.addEventListener('mouseover', () => {
                        addBtn.style.backgroundColor = 'rgba(55, 191, 27, 0.2)';  // Fondo verde suave
                        addBtn.style.transform = 'scale(1.1)';
                      });
                      addBtn.addEventListener('mouseout', () => {
                        addBtn.style.backgroundColor = '';  // Vuelve al fondo original
                        addBtn.style.transform = '';
                      });
                    }

                    // Efecto hover para el botÃ³n de eliminar
                    if (removeBtn) {
                      removeBtn.addEventListener('mouseover', () => {
                        removeBtn.style.backgroundColor = 'rgba(255, 0, 0, 0.2)';  // Fondo rojo suave
                        removeBtn.style.transform = 'scale(1.1)';
                      });
                      removeBtn.addEventListener('mouseout', () => {
                        removeBtn.style.backgroundColor = '';  // Vuelve al fondo original
                        removeBtn.style.transform = '';
                      });
                    }

                    // Estilo para el contenedor de botones
                    const friendActions = item.querySelector('.friend-actions') as HTMLElement;
                    if (friendActions) {
                      friendActions.style.display = 'flex';
                      friendActions.style.gap = '10px';
                    }
                  });
                }
            }
          }
        } catch (error) {
          console.error("Error al obtener las solicitudes de amistad:", error);
        }
      };
  
      getSolicitudes();
    </script>
  
    <div id="solicitudes-list"></div>
  </client:only>
</div>


<style>
/* ðŸ”¹ RESET GENERAL */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

/* ðŸ”¹ ELIMINAR SCROLL HORIZONTAL */
html, body {
  width: 100vw;
  height: 100vh;
  overflow-x: hidden;
  background-color: #282032;
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* ðŸ”¹ NAVBAR OCUPANDO TODO EL ANCHO */
.navbar-container {
  width: 100%;
  position: sticky; /* ðŸ”¹ AHORA SE MUEVE CON EL SCROLL */
  top: 0;
  left: 0;
  background: #282032;
  padding: 10px 0;
  z-index: 1000;
}

Navbar {
  width: 100%;
  display: flex;
  justify-content: space-between;
  padding: 0 20px;
}

/* ðŸ”¹ LOGO SUPERPUESTO AL NAVBAR */
.logo-container {
  position: absolute;
  top: 20px;
  left: 50%;
  transform: translate(-50%, -20%);
  z-index: 1001; /* MÃ¡s alto que la NavBar */
  display: flex;
  justify-content: center;
  align-items: center;
  width: 100%;
  gap: 20px; /* Espacio entre elementos */
}

.logo-container img {
  width: 120px; /* Ajustar tamaÃ±o si es necesario */
  height: auto;
}

/* ðŸ”¹ CONTENEDOR PRINCIPAL */
.container {
  width: 100vw;
  max-width: 100%;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  background: #282032;
  padding: 20px;
  margin-top: 80px; /* Ajuste para que no tape la NavBar */
  width: 800px;
}

/* ðŸ”¹ CABECERA */
.header {
  width: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 20px 0;
  margin-top: -70px;
}

.title {
  color: white;
  font-size: 32px;
  font-weight: bold;
  text-align: center;
  font-family: 'Luckiest Guy', cursive;
  letter-spacing: 1px; /* Opcional: mejora la legibilidad */
}

/* ðŸ”¹ TABS OCUPANDO TODO EL ANCHO */
.tabs {
  display: flex;
  justify-content: center;
  gap: 15px;
  width: 100%;
  max-width: 800px;
  background: #3e005a;
  border-radius: 10px;
  padding: 10px;
  margin-bottom: 20px;
}

.tab {
  background: #57257a;
  color: white;
  border: none;
  font-size: 16px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 20px;
  border-radius: 12px;
  transition: background 0.3s ease;
  flex: 1; /* ðŸ”¹ Distribuye el espacio equitativamente */
  justify-content: center;
}

.tab:hover {
  background: #282032;
}

.icon {
  width: 24px;
  height: auto;
}

.badge {
  background: green;
  color: white;
  padding: 3px 8px;
  border-radius: 50%;
  font-size: 14px;
}

/* ðŸ”¹ LISTA DE AMIGOS */
.friends-list {
  background: #666;
  padding: 20px;
  border-radius: 10px;
  text-align: left;
  width: 100%;
  max-width: 800px;
}

.no-solicitudes {
  text-align: center;
  font-size: 18px;
  color: #ccc;
  font-weight: bold;
  padding: 20px;
  border: 2px dashed #774a9b; /* Borde sutil para destacar */
  border-radius: 10px;
  background: rgba(255, 255, 255, 0.05);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 10px;
  max-width: 400px;
  margin: 20px auto; /* Centra el contenido */
}

/* ðŸ”¹ ICONO PARA CUANDO NO HAY AMIGOS */
.no-solicitudes img {
  width: 80px;
  height: auto;
  opacity: 0.7;
}



/* ðŸ”¹ RESPONSIVE */
@media (max-width: 768px) {
  .tabs {
    flex-direction: column;
    width: 90%;
  }

  .tab {
    width: 100%;
  }

  .friends-list {
    width: 90%;
  }

  .logo-container img {
    width: 100px;
  }
}
</style>